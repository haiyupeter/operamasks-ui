(function(a){a.treeview={};var b=(a.treeview.classes={open:"open",closed:"closed",expandable:"expandable",expandableHitarea:"expandable-hitarea",lastExpandableHitarea:"lastExpandable-hitarea",collapsable:"collapsable",collapsableHitarea:"collapsable-hitarea",lastCollapsableHitarea:"lastCollapsable-hitarea",lastCollapsable:"lastCollapsable",lastExpandable:"lastExpandable",last:"last",hitarea:"hitarea"});a.widget("om.omTree",{_swapClass:function(f,e,d){var c=f.filter("."+e);f.filter("."+d).removeClass(d).addClass(e);c.removeClass(e).addClass(d)},_getParentNode:function(d){if(d){var c=a(d).parent().parent();if(c&&c.hasClass("om-tree-node")){return c}}return null},_setParentCheckbox:function(e){var h=this._getParentNode(e);if(h){var g=h.find(">ul >li >div.tree-checkbox");var c=g.length;var i=g.filter(".checkbox_full").length;var d=g.filter(".checkbox_part").length;var f=h.find(">div.tree-checkbox");f.removeClass("checkbox_full checkbox_part");if(i==c){f.addClass("checkbox_full")}else{if(i>0||d>0){f.addClass("checkbox_part")}}this._setParentCheckbox(h)}},_setChildCheckbox:function(d,c){var e=d.find(">ul").find(".tree-checkbox");e.removeClass("checkbox_part checkbox_full");if(c){e.addClass("checkbox_full")}},_applyEvents:function(i){var d=this,g=d.options,j=g.onClick,h=g.onDblClick,f=g.onRightClick,e=g.onDrag,c=g.onDrop;i.find("span a").bind("click",function(l){var k=d.element.data("nodes")[a(this).parent().parent().attr("id")];j&&j.call(d,k);d.select(k);return false}).bind("dblclick",function(o){var m=a(this).parent().parent();var n=d.element.data("nodes")[m.attr("id")];if(m.has("ul").length>0&&a(o.target,this)){d.toggler(m)}if(m.hasClass("hasChildren")){var l=m.removeClass("hasChildren").find("ul");var k=d.element.data("init_dataSource");if(typeof k=="string"){d._ajaxLoad(l,k)}}h&&h.call(d,n)}).bind("mouseup",function(l){if(l.button==2){var k=d.element.data("nodes")[a(this).parent().parent().attr("id")];f&&f.call(d,k)}}).bind("mouseover mouseout",function(k){if(k.type=="mouseover"){a(this).addClass("hover")}else{if(k.type=="mouseout"){a(this).removeClass("hover")}}return false});d._bindHitEvent(i);i.find("div.tree-checkbox").click(function(l){var k=a(this).parent();d._toggleCheck(k,d.isCheck(d.findByNId(k.attr("id"))))});if(d.options.draggable){i.draggable({revert:"invalid",drag:function(){e&&e(node)}});i.find(">span").droppable({accept:"li.om-tree-node",hoverClass:"treenode-droppable",drop:function(l,p){var o,q,r=p.draggable;var k=a(l.target).parent();var n=k.find(">ul");r.css("left","");r.css("top","");var s=d.findByNId(r.attr("id"));if(k.has("ul").length>0){o=d.findByNId(k.attr("id"))}else{q=d.findByNId(k.attr("id"))}d.remove(s);d.insert(s,o,q,true);var m=d.findByNId(r.parent().find("li").attr("id"));c&&c(m)}})}i.bind("mousedown",function(k){k.stopPropagation()})},_bindHitEvent:function(d){var c=this;d.find("div.hitarea").click(function(){var g=a(this).parent();c.toggler(g);if(g.hasClass("hasChildren")){var f=g.removeClass("hasChildren").find("ul");var e=c.element.data("init_dataSource");if(typeof e=="string"){c._ajaxLoad(f,e)}}})},options:{initExpandLevel:0,lineHover:false,showIcon:true,showLine:true,showCheckbox:false,cascadeCheck:true,draggable:false,filter:null,nodeCount:0},_create:function(){var c=this,d=c.options;if(d.toggle){var f=d.toggle;d.toggle=function(){return f.apply(a(this).parent()[0],arguments)}}var e=c.element;e.data("nodes",[]);e.data("selected","");e.addClass("treeview")},updateNode:function(f){var d=this,e=d.options;var c=f.find("li");d._applyEvents(c);if(e.control){d._treeController(d,e.control)}},toggler:function(f){var j=this,k=j.options;var c=f.attr("id");var d=j.findByNId(c);var e=f.hasClass(b.expandable);if(e){var i=k.onBeforeExpand;if(i&&false===i(d)){return j}}else{var g=k.onBeforeCollapse;if(g&&false===g(d)){return j}}var h=f.find(f.find(">.hitarea"));j._swapClass(h,b.collapsableHitarea,b.expandableHitarea);j._swapClass(h,b.lastCollapsableHitarea,b.lastExpandableHitarea);j._swapClass(f,b.collapsable,b.expandable);j._swapClass(f,b.lastCollapsable,b.lastExpandable);f.find(">ul").each(function(){if(e){a(this).show();var m=k.onExpand;m&&m.call(this,d)}else{a(this).hide();var l=k.onCollapse;l&&l.call(this,d)}})},_init:function(){var c=this,d=c.options,f=c.element,e=d.dataSource;f.data("init_dataSource",e);if(e){if(typeof e=="string"){c._ajaxLoad(f,e)}else{if(typeof e=="object"){c._appendNodes.apply(c,[f,e]);c.updateNode(f)}}}},_ajaxLoad:function(h,e){var c=this,d=this.options,g=d.onBeforeLoad,i=d.onSuccess,f=d.onError;g&&g(c.findByNId(h.parent().attr("id")));a.ajax({url:e,method:"POST",dataType:"json",success:function(j){c._appendNodes.apply(c,[h,j]);c.setData(j);c.updateNode(h);i&&i.call(c,j)},error:function(j,l,k){f&&f.call(c,j,l,k)}})},check:function(c){this._toggleCheck(a("#"+c.nid),false)},uncheck:function(c){this._toggleCheck(a("#"+c.nid),true)},_toggleCheck:function(g,e){var f=g.find(">div.tree-checkbox"),c=this;if(e){f.removeClass("checkbox_part checkbox_full")}else{f.removeClass("checkbox_part").addClass("checkbox_full")}if(c.options.cascadeCheck){c._setChildCheckbox(g,!e);c._setParentCheckbox(g)}var d=c.options.onCheck;d&&d(c.findByNId(g.attr("id")))},checkAll:function(c){if(c){this.element.find(".tree-checkbox").removeClass("checkbox_part").addClass("checkbox_full")}else{this.element.find(".tree-checkbox").removeClass("checkbox_part checkbox_full")}},isCheck:function(c){return a("#"+c.nid).find(">div.tree-checkbox").hasClass("checkbox_full")},getChecked:function(f){var d=this,c=[];var e=f?".checkbox_full":":not(.checkbox_full)";this.element.find(".tree-checkbox").filter(e).each(function(h,g){c.push(d.element.data("nodes")[a(this).parent().attr("id")])});return c},select:function(d){var j=this,k=this.options,i=k.onBeforeSelect,e=k.onSelect;if(i&&false===i(d)){return j}var c=a("#"+d.nid);var h=a(" >span >a",c);h.addClass("selected");var f=j.element.data("selected");var g=c.attr("id");if(f!=""&&!(f==g)){a("#"+f+" >span >a").removeClass("selected")}j.element.data("selected",g);e&&e(d)},unselect:function(g){var e=this;var f=a("#"+g.nid);var c=a(" >span >a",f);c.removeClass("selected");var h=e.element.data("selected");var d=f.attr("id");if(h==d){e.element.data("selected","")}},getSelected:function(){var c=this.element.data("selected");return c?this.element.data("nodes")[c]:null},findNodes:function(h,k,g,e){var d=[],c;var j=g?g.children:this.getData();if(j&&(c=j.length)>0){for(var f=0;f<c;f++){d=this._searchNode.apply(j[f],[h,k,this._searchNode,d,false,e])}}return d.length>0?d:null},findNode:function(h,k,g,d){var f,c,j=g?g.children:this.getData();if(j&&(c=j.length)>0){for(var e=0;e<c;e++){f=this._searchNode.apply(j[e],[h,k,this._searchNode,[],true,d]);if(f!=null){return f}}}return null},findByNId:function(c){return this.element.data("nodes")[c]},findNodesBy:function(j,h,e){var g,k=h?h.children:this.getData();var d=[];for(var f=0,c=k.length;f<c;f++){if(j.call(k[f],k[f])===true){d.push(k[f])}if(e&&k[f].children){g=this.findNodesBy(j,k[f],e);if(g){d=d.concat(g)}}}return d.length>0?d:null},findNodeBy:function(h,g,d){var f,j=g?g.children:this.getData();for(var e=0,c=j.length;e<c;e++){if(h.call(j[e],j[e])===true){return j[e]}if(d){f=this.findNodeBy(h,j[e],d);if(f!=null){return f}}}return null},_searchNode:function(h,k,f,c,j,d){if(j){if(this[h]==k){return this}if(this.children&&this.children.length&&d){for(var g in this.children){var e=f.apply(this.children[g],[h,k,f,[],true]);if(e){return e}}}}else{if(this[h]==k){c.push(this)}if(this.children&&this.children.length&&d){a.each(this.children,f,[h,k,f,c,false])}return c}},getParent:function(d){var c=this.element.data("nodes")["pid"+d.nid];return this.findByNId(c)},getChildren:function(c){return c.children},getData:function(){return this.options.dataSource},setData:function(c){this.options.dataSource=c},expand:function(c){if(c.nid){this._collapseHandler(b.expandable,a("#"+c.nid))}},collapse:function(c){if(c.nid){this._collapseHandler(b.collapsable,a("#"+c.nid))}},expandAll:function(){this._collapseHandler(b.expandable,this.element)},collapseAll:function(){this._collapseHandler(b.collapsable,this.element)},_collapseHandler:function(c,d){this.toggler(a("div."+b.hitarea,d).filter(function(){return c?a(this).parent("."+c).length:true}).parent());return false},refresh:function(j){var f=this,d=f.element;var h=f.getData();if(!j){d.data("nodes",[]);f.setData([]);d.html("");d.data("init_dataSource",h);if(typeof h=="string"){f._ajaxLoad(d,h)}else{if(typeof h=="object"){for(var g=0;g<h.length;g++){f.insert(h[g])}}}}else{var c=a("#"+j.nid).next();var e=d.data("nodes")["pid"+j.nid];f.remove(j);f.insert(j,f.findByNId(e),f.findByNId(c.attr("id")))}},_appendNodes:function(v,m,e,f){var j=this,t=[];var g=j.options.showCheckbox;var c=j.element.attr("id")?j.element.attr("id"):("treeId"+parseInt(Math.random()*1000));j.element.attr("id",c);for(var q=0,o=m.length;q<o;q++){var n=m[q],k=(q==(m.length-1));var w="om-tree-node "+(g?"treenode-checkable ":"")+(n.hasChildren?"hasChildren ":"");var h=c+"_"+(++j.options.nodeCount);n.nid=h;var d=j.element.data("nodes");d[n.nid]=n;if(typeof v=="string"){d["pid"+n.nid]=v;if(k){v=null}}else{d["pid"+n.nid]=v.parent("li").attr("id")}var u=[];if(n.children&&n.children.length>0){u.push((j._appendNodes(n.nid,n.children)).join(""))}var r=0;if(n.children&&(r=n.children.length)>0||n.hasChildren){if(n.expanded){w=w+"open "+b.collapsable+" "+(k?b.lastCollapsable:"")}else{w=w+b.expandable+" "+(k?b.lastExpandable:"")}}else{w=w+(k?b.last:"")}t.push("<li id='",n.nid,"' class='",w,"'>");if(n.hasChildren||r>0){var s="";a.each(w.split(" "),function(){s+=this+"-hitarea "});t.push("<div class='",b.hitarea+" "+s,"'/>")}if(g){t.push("<div class='tree-checkbox'/>")}var p=(n.classes?n.classes:"");if(j.options.showIcon){if(n.hasChildren||n.children&&n.children.length>0){p=p+" folder "}else{p=p+" file "}}t.push("<span class='",p,"'>","<a href='#'>",n.text,"</a></span>");if(n.hasChildren||r>0){t.push("<ul"," style='display:",(n.expanded?"block":"none"),"'>");t.push(u.join(""));t.push("</ul>")}t.push("</li>")}if(e){if(f){a("#"+e.nid).after(t.join(""))}else{a("#"+e.nid).before(t.join(""))}}else{if(v){v.append(t.join(""))}}return t},remove:function(j,l){var k,m=this,f=l?l.children:m.getData();for(var g in f){if(f[g]==j){var c=[];c=m._findChildrenId(j,c);c.push(j.nid);for(var d=0,h=c.length;d<h;d++){delete m.element.data("nodes")[c[d]];delete m.element.data("nodes")["pid"+c[d]]}if(j.nid==m.element.data("selected")){this.element.data("selected",null)}var e=a("#"+j.nid).prev();if(a("#"+j.nid).next().length<1&&e.length>0){if(e.hasClass(b.collapsable)){e.addClass(b.lastCollapsable);e.find("div").addClass(b.lastCollapsableHitarea)}else{if(e.hasClass(b.expandable)){e.addClass(b.lastExpandable);e.find("div").addClass(b.lastExpandableHitarea)}else{e.addClass(b.last)}}}a("#"+j.nid).remove();f.splice(g,1);if(l&&l.nid&&f.length<1){m._changeToFolderOrFile(l,false)}return true}else{if(f[g].children){k=m.remove(j,f[g]);if(k){return true}}}}return false},_findChildrenId:function(g,f){if(g.children){for(var e=0,d=g.children,c=d.length;e<c;e++){f.push(d[e].nid);if(d[e].children){this._findChildrenId(d[e],f)}}}return f},insert:function(i,l,c,j){var n=this,d=[],k;d.push(i);if(c){l=l||n.findByNId(n.element.data("nodes")["pid"+c.nid])}var h,g=l?l.children:n.getData();if(l&&(!l.children||l.children.length<1)){n._changeToFolderOrFile(l,true);n._bindHitEvent(a("#"+l.nid));g=l.children=[]}k=l?a("#"+l.nid).children("ul").first():n.element;if(c&&((h=a.inArray(c,g))>=0)){n._appendNodes(k,d,c,j);g.splice(h,0,i)}else{n._appendNodes(k,d,c,j);g.push(i)}var f=k.find("li").filter("."+b.last+",."+b.lastCollapsable+",."+b.lastExpandable).not(k.find("li").filter(":last-child:not(ul)"));f.removeClass(b.last+" "+b.lastCollapsable+" "+b.lastExpandable);f.find(" >div").removeClass(b.lastCollapsableHitarea+" "+b.lastExpandableHitarea);var e=a("#"+i.nid).add(a("#"+i.nid).find("li"));n._applyEvents(e)},_changeToFolderOrFile:function(g,h){var f=a("#"+g.nid),d=this;if(h){var e=a("<ul/>").css("display","block").appendTo(f);f.addClass("open "+b.collapsable);d._swapClass(f,b.last,b.lastCollapsable);g.children=[]}else{f.find("ul").remove();f.find("div."+b.hitarea).remove();f.filter("."+b.lastCollapsable+",."+b.lastExpandable).removeClass(b.lastCollapsable+" "+b.lastExpandable).addClass(b.last);f.removeClass("open "+b.collapsable+" "+b.expandable)}if(d.options.showIcon){d._swapClass(f.children("span"),"file","folder")}var c=f.filter(":has(>ul)").prepend('<div class="'+b.hitarea+'"/>').find("div."+b.hitarea);c.each(function(){var i="";a.each(a(this).parent().attr("class").split(" "),function(){i+=this+"-hitarea "});a(this).addClass(i)})},modify:function(h,f,e){var d=this,c=a("#"+h.nid).next(),g;e=e||this.findByNId(d.element.data("nodes")["pid"+h.nid]);if(c.is("ul")||c.is("li")){g=d.findByNId(c.attr("id"))}d.remove(h,e);d.insert(f,e,g)},disable:function(){},enable:function(){}})})(jQuery);